const { cmd, commands } = require('../command');
const axios = require('axios');

cmd({
    pattern: "pair",
    alias: ["getpair", "clonebot"],
    react: "‚úÖ",
    desc: "Get pairing code for CRISS-AI bot",
    category: "download",
    use: ".pair +255687068XXX",
    filename: __filename
}, async (conn, mek, m, {
    from, quoted, body, isCmd, command, args, q, isGroup,
    sender, senderNumber, botNumber2, botNumber, pushname,
    isMe, isOwner, groupMetadata, groupName, participants,
    groupAdmins, isBotAdmins, isAdmins, reply
}) => {
    try {
        const phoneNumber = q ? q.trim() : null;

        // Validate phone number format
        if (!phoneNumber || !phoneNumber.match(/^\+?\d{10,15}$/)) {
        await conn.sendMessage(m.chat, {
      text: "Please provide a valid phone number with the country code.\nExample: `.pair +267775117191",
      contextInfo: {
                    mentionedJid: [m.sender],
                    forwardingScore: 999,
                    isForwarded: true,
                    forwardedNewsletterMessageInfo: {
                        newsletterJid: '120363399999197102@newsletter',
                        newsletterName: '‚ï≠‚Ä¢‚Ä¢‚û§¬ÆNjabulo Jb',
                        serverMessageId: 143
                    }
               }
             }, { quoted: {
            key: {
                fromMe: false,
                participant: `0@s.whatsapp.net`,
                remoteJid: "status@broadcast"
            },
            message: {
                contactMessage: {
                    displayName: "‚úÜÔ∏éN◊†…ê·Ç¶œÖ‚ÑìœÉ ◊†·Ç¶ verified",
                    vcard: `BEGIN:VCARD\nVERSION:3.0\nN:Njabulo-Jb;BOT;;;\nFN:Njabulo-Jb\nitem1.TEL;waid=254700000000:+254 700 000000\nitem1.X-ABLabel:Bot\nEND:VCARD`
                }
            }
        } });
  }

        // Request pairing code from your backend
        const response = await axios.get(`https://site-scan-c9e56a13c943.herokuapp.com/pair?phone=${encodeURIComponent(phoneNumber)}`);

        if (!response.data || !response.data.code) {
        await conn.sendMessage(m.chat, {
      text: "Failed to retrieve pairing code. Please try again later.",
      contextInfo: {
                    mentionedJid: [m.sender],
                    forwardingScore: 999,
                    isForwarded: true,
                    forwardedNewsletterMessageInfo: {
                        newsletterJid: '120363399999197102@newsletter',
                        newsletterName: '‚ï≠‚Ä¢‚Ä¢‚û§¬ÆNjabulo Jb',
                        serverMessageId: 143
                    }
               }
             }, { quoted: {
            key: {
                fromMe: false,
                participant: `0@s.whatsapp.net`,
                remoteJid: "status@broadcast"
            },
            message: {
                contactMessage: {
                    displayName: "‚úÜÔ∏éN◊†…ê·Ç¶œÖ‚ÑìœÉ ◊†·Ç¶ verified",
                    vcard: `BEGIN:VCARD\nVERSION:3.0\nN:Njabulo-Jb;BOT;;;\nFN:Njabulo-Jb\nitem1.TEL;waid=254700000000:+254 700 000000\nitem1.X-ABLabel:Bot\nEND:VCARD`
                }
            }
        } });
        }

        const pairingCode = response.data.code;

  
        await conn.sendMessage(m.chat, {
      text: `üì≤ *Phone:* ${phoneNumber}\nüîê *Pairing Code:* ${pairingCode}`,
      contextInfo: {
                    mentionedJid: [m.sender],
                    forwardingScore: 999,
                    isForwarded: true,
                    forwardedNewsletterMessageInfo: {
                        newsletterJid: '120363399999197102@newsletter',
                        newsletterName: '‚ï≠‚Ä¢‚Ä¢‚û§¬ÆNjabulo Jb',
                        serverMessageId: 143
                    }
               }
             }, { quoted: {
            key: {
                fromMe: false,
                participant: `0@s.whatsapp.net`,
                remoteJid: "status@broadcast"
            },
            message: {
                contactMessage: {
                    displayName: "‚úÜÔ∏éN◊†…ê·Ç¶œÖ‚ÑìœÉ ◊†·Ç¶ verified",
                    vcard: `BEGIN:VCARD\nVERSION:3.0\nN:Njabulo-Jb;BOT;;;\nFN:Njabulo-Jb\nitem1.TEL;waid=254700000000:+254 700 000000\nitem1.X-ABLabel:Bot\nEND:VCARD`
                }
            }
        } });
    } catch (error) {
        console.error("Pair command error:", error);
        await reply("‚ùå An error occurred while fetching the pairing code. Please try again later.");
    }
});


      
